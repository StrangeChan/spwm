#include "math.h"
#include "led.h" 
#include "spwm.h" 
#include "stdio.h"
#include "adc.h"

#define CCR3_Val  2
extern u16 adc_count;

u16 Time_control;
u16 r1,r2,time,set_fre,r0;
u16 sin_counter;

u8 flag_sin=1;
//u16 adc_test,adc_cal;


const uint16_t sin_tab[2000] ={3,6,11,17,23,28,34,40,45,51,57,62,68,74,79,85,
90,96,102,107,113,119,124,130,136,141,147,153,158,164,170,175,
181,187,192,198,203,209,215,220,226,232,237,243,249,254,260,266,
271,277,282,288,294,299,305,311,316,322,328,333,339,344,350,356,
361,367,373,378,384,389,395,401,406,412,418,423,429,434,440,446,
451,457,462,468,474,479,485,490,496,502,507,513,518,524,530,535,
541,546,552,558,563,569,574,580,585,591,597,602,608,613,619,625,
630,636,641,647,652,658,663,669,675,680,686,691,697,702,708,713,
719,724,730,736,741,747,752,758,763,769,774,780,785,791,796,802,
807,813,818,824,829,835,840,846,851,857,862,868,873,879,884,890,
895,901,906,912,917,923,928,934,939,944,950,955,961,966,972,977,
983,988,994,999,1004,1010,1015,1021,1026,1031,1037,1042,1048,1053,1059,1064,
1069,1075,1080,1086,1091,1096,1102,1107,1112,1118,1123,1129,1134,1139,1145,1150,
1155,1161,1166,1171,1177,1182,1187,1193,1198,1203,1209,1214,1219,1225,1230,1235,
1241,1246,1251,1257,1262,1267,1273,1278,1283,1288,1294,1299,1304,1309,1315,1320,
1325,1331,1336,1341,1346,1351,1357,1362,1367,1372,1378,1383,1388,1393,1399,1404,
1409,1414,1419,1425,1430,1435,1440,1445,1450,1456,1461,1466,1471,1476,1481,1487,
1492,1497,1502,1507,1512,1517,1523,1528,1533,1538,1543,1548,1553,1558,1563,1569,
1574,1579,1584,1589,1594,1599,1604,1609,1614,1619,1624,1629,1634,1639,1644,1649,
1654,1660,1665,1670,1675,1680,1685,1690,1695,1700,1705,1709,1714,1719,1724,1729,
1734,1739,1744,1749,1754,1759,1764,1769,1774,1779,1784,1789,1793,1798,1803,1808,
1813,1818,1823,1828,1833,1837,1842,1847,1852,1857,1862,1867,1871,1876,1881,1886,
1891,1895,1900,1905,1910,1915,1919,1924,1929,1934,1939,1943,1948,1953,1958,1962,
1967,1972,1976,1981,1986,1991,1995,2000,2005,2009,2014,2019,2024,2028,2033,2038,
2042,2047,2051,2056,2061,2065,2070,2075,2079,2084,2088,2093,2098,2102,2107,2111,
2116,2121,2125,2130,2134,2139,2143,2148,2152,2157,2162,2166,2171,2175,2180,2184,
2189,2193,2198,2202,2206,2211,2215,2220,2224,2229,2233,2238,2242,2246,2251,2255,
2260,2264,2268,2273,2277,2282,2286,2290,2295,2299,2303,2308,2312,2316,2321,2325,
2329,2334,2338,2342,2347,2351,2355,2359,2364,2368,2372,2376,2381,2385,2389,2393,
2398,2402,2406,2410,2414,2419,2423,2427,2431,2435,2440,2444,2448,2452,2456,2460,
2464,2468,2473,2477,2481,2485,2489,2493,2497,2501,2505,2509,2513,2517,2521,2526,
2530,2534,2538,2542,2546,2550,2554,2558,2562,2565,2569,2573,2577,2581,2585,2589,
2593,2597,2601,2605,2609,2613,2617,2620,2624,2628,2632,2636,2640,2644,2647,2651,
2655,2659,2663,2666,2670,2674,2678,2682,2685,2689,2693,2697,2700,2704,2708,2712,
2715,2719,2723,2726,2730,2734,2737,2741,2745,2748,2752,2756,2759,2763,2767,2770,
2774,2777,2781,2785,2788,2792,2795,2799,2802,2806,2810,2813,2817,2820,2824,2827,
2831,2834,2838,2841,2845,2848,2851,2855,2858,2862,2865,2869,2872,2875,2879,2882,
2886,2889,2892,2896,2899,2902,2906,2909,2912,2916,2919,2922,2926,2929,2932,2936,
2939,2942,2945,2949,2952,2955,2958,2962,2965,2968,2971,2974,2977,2981,2984,2987,
2990,2993,2996,3000,3003,3006,3009,3012,3015,3018,3021,3024,3027,3030,3034,3037,
3040,3043,3046,3049,3052,3055,3058,3061,3064,3067,3070,3072,3075,3078,3081,3084,
3087,3090,3093,3096,3099,3102,3104,3107,3110,3113,3116,3119,3121,3124,3127,3130,
3133,3135,3138,3141,3144,3146,3149,3152,3155,3157,3160,3163,3166,3168,3171,3174,
3176,3179,3182,3184,3187,3189,3192,3195,3197,3200,3202,3205,3208,3210,3213,3215,
3218,3220,3223,3225,3228,3230,3233,3235,3238,3240,3243,3245,3248,3250,3253,3255,
3257,3260,3262,3265,3267,3269,3272,3274,3276,3279,3281,3283,3286,3288,3290,3293,
3295,3297,3299,3302,3304,3306,3308,3311,3313,3315,3317,3319,3322,3324,3326,3328,
3330,3332,3335,3337,3339,3341,3343,3345,3347,3349,3351,3353,3355,3358,3360,3362,
3364,3366,3368,3370,3372,3374,3376,3377,3379,3381,3383,3385,3387,3389,3391,3393,
3395,3397,3399,3400,3402,3404,3406,3408,3410,3411,3413,3415,3417,3419,3420,3422,
3424,3426,3427,3429,3431,3432,3434,3436,3438,3439,3441,3443,3444,3446,3447,3449,
3451,3452,3454,3455,3457,3459,3460,3462,3463,3465,3466,3468,3469,3471,3472,3474,
3475,3477,3478,3480,3481,3483,3484,3485,3487,3488,3490,3491,3492,3494,3495,3497,
3498,3499,3501,3502,3503,3504,3506,3507,3508,3510,3511,3512,3513,3515,3516,3517,
3518,3519,3521,3522,3523,3524,3525,3526,3527,3529,3530,3531,3532,3533,3534,3535,
3536,3537,3538,3539,3540,3541,3542,3543,3544,3545,3546,3547,3548,3549,3550,3551,
3552,3553,3554,3555,3556,3557,3557,3558,3559,3560,3561,3562,3562,3563,3564,3565,
3566,3566,3567,3568,3569,3569,3570,3571,3572,3572,3573,3574,3574,3575,3576,3576,
3577,3578,3578,3579,3579,3580,3581,3581,3582,3582,3583,3583,3584,3585,3585,3586,
3586,3587,3587,3588,3588,3588,3589,3589,3590,3590,3591,3591,3591,3592,3592,3593,
3593,3593,3594,3594,3594,3595,3595,3595,3595,3596,3596,3596,3597,3597,3597,3597,
3597,3598,3598,3598,3598,3598,3599,3599,3599,3599,3599,3599,3599,3599,3600,3600,
3600,3600,3600,3600,3600,3600,3600,3600,3600,3600,3600,3600,3600,3600,3600,3600,
3600,3600,3600,3599,3599,3599,3599,3599,3599,3599,3599,3598,3598,3598,3598,3598,
3597,3597,3597,3597,3597,3596,3596,3596,3595,3595,3595,3595,3594,3594,3594,3593,
3593,3593,3592,3592,3591,3591,3591,3590,3590,3589,3589,3588,3588,3588,3587,3587,
3586,3586,3585,3585,3584,3583,3583,3582,3582,3581,3581,3580,3579,3579,3578,3578,
3577,3576,3576,3575,3574,3574,3573,3572,3572,3571,3570,3569,3569,3568,3567,3566,
3566,3565,3564,3563,3562,3562,3561,3560,3559,3558,3557,3557,3556,3555,3554,3553,
3552,3551,3550,3549,3548,3547,3546,3545,3544,3543,3542,3541,3540,3539,3538,3537,
3536,3535,3534,3533,3532,3531,3530,3529,3527,3526,3525,3524,3523,3522,3521,3519,
3518,3517,3516,3515,3513,3512,3511,3510,3508,3507,3506,3504,3503,3502,3501,3499,
3498,3497,3495,3494,3492,3491,3490,3488,3487,3485,3484,3483,3481,3480,3478,3477,
3475,3474,3472,3471,3469,3468,3466,3465,3463,3462,3460,3459,3457,3455,3454,3452,
3451,3449,3447,3446,3444,3443,3441,3439,3438,3436,3434,3432,3431,3429,3427,3426,
3424,3422,3420,3419,3417,3415,3413,3411,3410,3408,3406,3404,3402,3400,3399,3397,
3395,3393,3391,3389,3387,3385,3383,3381,3379,3377,3376,3374,3372,3370,3368,3366,
3364,3362,3360,3358,3355,3353,3351,3349,3347,3345,3343,3341,3339,3337,3335,3332,
3330,3328,3326,3324,3322,3319,3317,3315,3313,3311,3308,3306,3304,3302,3299,3297,
3295,3293,3290,3288,3286,3283,3281,3279,3276,3274,3272,3269,3267,3265,3262,3260,
3257,3255,3253,3250,3248,3245,3243,3240,3238,3235,3233,3230,3228,3225,3223,3220,
3218,3215,3213,3210,3208,3205,3202,3200,3197,3195,3192,3189,3187,3184,3182,3179,
3176,3174,3171,3168,3166,3163,3160,3157,3155,3152,3149,3146,3144,3141,3138,3135,
3133,3130,3127,3124,3121,3119,3116,3113,3110,3107,3104,3102,3099,3096,3093,3090,
3087,3084,3081,3078,3075,3072,3070,3067,3064,3061,3058,3055,3052,3049,3046,3043,
3040,3037,3034,3030,3027,3024,3021,3018,3015,3012,3009,3006,3003,3000,2996,2993,
2990,2987,2984,2981,2977,2974,2971,2968,2965,2962,2958,2955,2952,2949,2945,2942,
2939,2936,2932,2929,2926,2922,2919,2916,2912,2909,2906,2902,2899,2896,2892,2889,
2886,2882,2879,2875,2872,2869,2865,2862,2858,2855,2851,2848,2845,2841,2838,2834,
2831,2827,2824,2820,2817,2813,2810,2806,2802,2799,2795,2792,2788,2785,2781,2777,
2774,2770,2767,2763,2759,2756,2752,2748,2745,2741,2737,2734,2730,2726,2723,2719,
2715,2712,2708,2704,2700,2697,2693,2689,2685,2682,2678,2674,2670,2666,2663,2659,
2655,2651,2647,2644,2640,2636,2632,2628,2624,2620,2617,2613,2609,2605,2601,2597,
2593,2589,2585,2581,2577,2573,2569,2565,2562,2558,2554,2550,2546,2542,2538,2534,
2530,2526,2521,2517,2513,2509,2505,2501,2497,2493,2489,2485,2481,2477,2473,2468,
2464,2460,2456,2452,2448,2444,2440,2435,2431,2427,2423,2419,2414,2410,2406,2402,
2398,2393,2389,2385,2381,2376,2372,2368,2364,2359,2355,2351,2347,2342,2338,2334,
2329,2325,2321,2316,2312,2308,2303,2299,2295,2290,2286,2282,2277,2273,2268,2264,
2260,2255,2251,2246,2242,2238,2233,2229,2224,2220,2215,2211,2206,2202,2198,2193,
2189,2184,2180,2175,2171,2166,2162,2157,2152,2148,2143,2139,2134,2130,2125,2121,
2116,2111,2107,2102,2098,2093,2088,2084,2079,2075,2070,2065,2061,2056,2051,2047,
2042,2038,2033,2028,2024,2019,2014,2009,2005,2000,1995,1991,1986,1981,1976,1972,
1967,1962,1958,1953,1948,1943,1939,1934,1929,1924,1919,1915,1910,1905,1900,1895,
1891,1886,1881,1876,1871,1867,1862,1857,1852,1847,1842,1837,1833,1828,1823,1818,
1813,1808,1803,1798,1793,1789,1784,1779,1774,1769,1764,1759,1754,1749,1744,1739,
1734,1729,1724,1719,1714,1709,1705,1700,1695,1690,1685,1680,1675,1670,1665,1660,
1654,1649,1644,1639,1634,1629,1624,1619,1614,1609,1604,1599,1594,1589,1584,1579,
1574,1569,1563,1558,1553,1548,1543,1538,1533,1528,1523,1517,1512,1507,1502,1497,
1492,1487,1481,1476,1471,1466,1461,1456,1450,1445,1440,1435,1430,1425,1419,1414,
1409,1404,1399,1393,1388,1383,1378,1372,1367,1362,1357,1351,1346,1341,1336,1331,
1325,1320,1315,1309,1304,1299,1294,1288,1283,1278,1273,1267,1262,1257,1251,1246,
1241,1235,1230,1225,1219,1214,1209,1203,1198,1193,1187,1182,1177,1171,1166,1161,
1155,1150,1145,1139,1134,1129,1123,1118,1112,1107,1102,1096,1091,1086,1080,1075,
1069,1064,1059,1053,1048,1042,1037,1031,1026,1021,1015,1010,1004,999,994,988,
983,977,972,966,961,955,950,944,939,934,928,923,917,912,906,901,
895,890,884,879,873,868,862,857,851,846,840,835,829,824,818,813,
807,802,796,791,785,780,774,769,763,758,752,747,741,736,730,724,
719,713,708,702,697,691,686,680,675,669,663,658,652,647,641,636,
630,625,619,613,608,602,597,591,585,580,574,569,563,558,552,546,
541,535,530,524,518,513,507,502,496,490,485,479,474,468,462,457,
451,446,440,434,429,423,418,412,406,401,395,389,384,378,373,367,
361,356,350,344,339,333,328,322,316,311,305,299,294,288,282,277,
271,266,260,254,249,243,237,232,226,220,215,209,203,198,192,187,
181,175,170,164,158,153,147,141,136,130,124,119,113,107,102,96,
90,85,79,74,68,62,57,51,45,40,34,28,23,17,11,6}; 

uint8_t fre_out = 50;
static uint16_t PrescalerValue = 0; 
uint16_t sin_m = 900;  //0 - 1024
uint32_t sin_step = 10;
uint16_t sin_count = 0;        //半周期计数值
uint32_t sin_num = 200;        //半周期点数
uint8_t sin_change_flag = 0;	//换桥臂标志
extern uint32_t sin_step_set ;
extern uint16_t sin_num_set ;        //半周期计数值
extern u8 change_numcount_flag ;
u8 change_sin_m_flag = 0;
extern u16 M_SET;
void SPWM_Init(void)  
{  
    TIM_TimeBaseInitTypeDef     TIM_TimeBaseStructure;  
    TIM_OCInitTypeDef           TIM_OCInitStructure;  
    GPIO_InitTypeDef            GPIO_InitStructure;  
    NVIC_InitTypeDef NVIC_InitStructure;    
		TIM_BDTRInitTypeDef TIM_BDTRInitStructure; 
    RCC_APB2PeriphClockCmd(RCC_APB2Periph_TIM1, ENABLE);  
    RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA|RCC_APB2Periph_GPIOB|RCC_APB2Periph_AFIO, ENABLE);  
	
    GPIO_InitStructure.GPIO_Pin = GPIO_Pin_8|GPIO_Pin_9;      //GPIOA.8 -- GPIOB.13    
    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP;    				//GPIOA.9 -- GPIOB.14   
    GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz; 
    GPIO_Init(GPIOA, &GPIO_InitStructure);     
    GPIO_InitStructure.GPIO_Pin = GPIO_Pin_13|GPIO_Pin_14;    
    GPIO_Init(GPIOB, &GPIO_InitStructure);  
	
    PrescalerValue = (uint16_t) (SystemCoreClock / 72000000) - 1; //72M
    TIM_TimeBaseStructure.TIM_Period = ZBF-1;                   //
    TIM_TimeBaseStructure.TIM_Prescaler = PrescalerValue;    
    TIM_TimeBaseStructure.TIM_ClockDivision = 0;     
    TIM_TimeBaseStructure.TIM_CounterMode = TIM_CounterMode_Up;     //向上计数
    TIM_TimeBaseStructure.TIM_RepetitionCounter = 0;    
    TIM_TimeBaseInit(TIM1, &TIM_TimeBaseStructure);  

		//初始化TIM1输入捕获参数 CH1 CH1N
    TIM_OCInitStructure.TIM_OCMode = TIM_OCMode_PWM1;     //pwm模式1
    TIM_OCInitStructure.TIM_OutputState = TIM_OutputState_Enable;    //比较输出使能
    TIM_OCInitStructure.TIM_OutputNState = TIM_OutputNState_Enable; //互补输出使能
    TIM_OCInitStructure.TIM_Pulse = CCR3_Val;      //电平跳变值
    TIM_OCInitStructure.TIM_OCPolarity = TIM_OCPolarity_High;    //模式1小于比较值为高电平
    TIM_OCInitStructure.TIM_OCNPolarity = TIM_OCNPolarity_High;  
    TIM_OCInitStructure.TIM_OCIdleState = TIM_OCIdleState_Set;  
    TIM_OCInitStructure.TIM_OCNIdleState = TIM_OCIdleState_Set;  
    TIM_OC1Init(TIM1, &TIM_OCInitStructure); 
    TIM_OC1PreloadConfig(TIM1, TIM_OCPreload_Enable); //预装使能   软件更改占空比的值是事件更新后生效，还是立即生效 		

		//初始化TIM1输入捕获参数 CH2 CH2N
    TIM_OCInitStructure.TIM_OCMode = TIM_OCMode_PWM1;    
    TIM_OCInitStructure.TIM_OutputState = TIM_OutputState_Enable;    
    TIM_OCInitStructure.TIM_OutputNState = TIM_OutputNState_Enable;
    TIM_OCInitStructure.TIM_Pulse = CCR3_Val;     
    TIM_OCInitStructure.TIM_OCPolarity = TIM_OCPolarity_High;    
    TIM_OCInitStructure.TIM_OCNPolarity = TIM_OCNPolarity_High;  
    TIM_OCInitStructure.TIM_OCIdleState = TIM_OCIdleState_Set;  
    TIM_OCInitStructure.TIM_OCNIdleState = TIM_OCIdleState_Set;  		
    TIM_OC2Init(TIM1, &TIM_OCInitStructure);     
    TIM_OC2PreloadConfig(TIM1, TIM_OCPreload_Enable); 
 	
		//初始化TIM1输入捕获参数 CH3
		TIM_OCInitStructure.TIM_OCMode = TIM_OCMode_PWM1;
		TIM_OCInitStructure.TIM_OutputState = TIM_OutputState_Enable;
		TIM_OCInitStructure.TIM_OutputNState = TIM_OutputNState_Disable;
		TIM_OCInitStructure.TIM_Pulse = CCR3_Val;
		TIM_OCInitStructure.TIM_OCPolarity = TIM_OCPolarity_High;
		TIM_OCInitStructure.TIM_OCNPolarity = TIM_OCPolarity_High;
		TIM_OCInitStructure.TIM_OCIdleState = TIM_OCIdleState_Set;
		TIM_OCInitStructure.TIM_OCNIdleState = TIM_OCIdleState_Set;
		TIM_OC3Init(TIM1, &TIM_OCInitStructure);	
		TIM_OC3PreloadConfig(TIM1, TIM_OCPreload_Enable);
		TIM_ITConfig(TIM1,TIM_IT_CC3,ENABLE);	 //允许更新中断 ,允许CC3IE捕获中断

		//设置TIM1互补通道间的软件固定死区，但IGBT本身自带死区可以不考虑软件死区
		TIM_BDTRInitStructure.TIM_OSSIState = TIM_OSSIState_Disable;
		TIM_BDTRInitStructure.TIM_OSSRState = TIM_OSSRState_Disable;
		TIM_BDTRInitStructure.TIM_LOCKLevel = TIM_LOCKLevel_OFF;
		TIM_BDTRInitStructure.TIM_DeadTime = 0x20;  //x MAX=12us死区 0x10 200ns
		TIM_BDTRInitStructure.TIM_Break = TIM_Break_Disable;
		TIM_BDTRInitStructure.TIM_BreakPolarity = TIM_BreakPolarity_High;
		TIM_BDTRInitStructure.TIM_AutomaticOutput = TIM_AutomaticOutput_Enable;	
		TIM_BDTRConfig(TIM1,&TIM_BDTRInitStructure);

    NVIC_InitStructure.NVIC_IRQChannel = TIM1_CC_IRQn;  
    NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 0;  
    NVIC_InitStructure.NVIC_IRQChannelSubPriority = 1;  
    NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;  
    NVIC_Init(&NVIC_InitStructure);      
          
    TIM_Cmd(TIM1, ENABLE);     
    TIM_CtrlPWMOutputs(TIM1, ENABLE);   //TIM1开
}  
void TIM1_CC_IRQHandler(void)  
{  
  if(TIM_GetITStatus(TIM1, TIM_IT_CC3) != RESET)   
  {   
#if 0
	  if(sin_change_flag == 0)
		{
			TIM1->CCR1 = (uint16_t)((sin_m * sin_tab[sin_count]) >>10); 
			TIM1->CCR2 = 0; 
		}
		else if(sin_change_flag == 1)
		{
			TIM1->CCR1 = 0;
			TIM1->CCR2 = (uint16_t)((sin_m * sin_tab[sin_count]) >>10); 				
		}
		sin_count += sin_step;
    if((sin_count/sin_step)>= sin_num)  
    {  
      sin_count = 0;			
			sin_change_flag = 1 - sin_change_flag; 
			if(change_numcount_flag == 1)
			{
				change_numcount_flag = 0;
				sin_num = sin_num_set;
				sin_step = sin_step_set;
			}
			if(change_sin_m_flag == 1)
			{
				change_sin_m_flag = 0;
				sin_m = M_SET;
			}	
    }
#endif
	
	if (time==2) 
			time=0;
                
		if (flag_sin==1){
			sin_counter++;
            if (sin_counter>=Time_control)
			{
				if ((set_fre==89||set_fre==92||set_fre==94||set_fre==96||set_fre==98||set_fre==99)&&time==1) {
                    if (sin_counter>Time_control) flag_sin=0;
                }
                else  flag_sin=0;
			}
		}
		if (flag_sin==0){
			sin_counter--;
			if (sin_counter==0){
				flag_sin=1;
				time++;
				
				if(change_sin_m_flag == 1)
				{
				change_sin_m_flag = 0;
				sin_m = M_SET;
				}	
			}
		}
//		
//		sin_counter++;
//		 if (sin_counter>=Time_control)
//		 {
//			 sin_counter = 0;
//			 time++;
//		 }
//		
		r0=(sin(3.14159f*sin_counter/Time_control/2)*3.51f*sin_m);
		
		//(uint16_t)((sin_m * sin_tab[sin_count]) >>10
		
		if (time==0){
			r2=0;
			r1=r0;  
		}                
         
		if (time==1){
			r1=0;
			r2=r0;
		}
	
		TIM1->CCR1 = r1;
		TIM1->CCR2 = r2;
	
	
    TIM1->SR = (uint16_t)~TIM_IT_CC3; 		
  } 
} 

void sin_cal(void)
{
	sin_num_set = (uint16_t)((10000.0 / fre_out)+0.4);
	sin_step_set = ((fre_out * 205) + 512) >> 10;
	adc_count = sin_num_set;
}
